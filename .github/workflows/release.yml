name: Release
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write  # For PR comments
  issues: write         # For issue comments

env:
  GO_VERSION: '1.25'

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: self-hosted
    outputs:
      coverage: ${{ steps.coverage.outputs.percentage }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install dependencies
        run: go mod download

      - name: Install build tools
        run: sudo apt-get update && sudo apt-get install -y build-essential

      - name: Run unit tests
        run: make test-unit

      - name: Generate coverage report
        run: make coverage-ci

      - name: Extract coverage percentage
        id: coverage
        run: |
          COVERAGE=$(grep "total:" coverage/coverage.txt | awk '{print $3}' | sed 's/%//')
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Coverage: $COVERAGE%"

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v5
        with:
          name: coverage-report
          path: coverage/

  gosec:
    name: GoSec Security Scan
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install dependencies
        run: go mod download

      - name: Install build tools
        run: sudo apt-get update && sudo apt-get install -y build-essential

      - name: Run GoSec security scan
        run: make gosec

  govulncheck:
    name: Vulnerability Check
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install dependencies
        run: go mod download

      - name: Install build tools
        run: sudo apt-get update && sudo apt-get install -y build-essential

      - name: Run vulnerability check
        run: make vuln

  linter:
    name: Code Linting
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install dependencies
        run: go mod download

      - name: Install build tools
        run: sudo apt-get update && sudo apt-get install -y build-essential

      - name: Run linting
        run: make lint

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install dependencies
        run: go mod download

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Set up Docker Compose V2
        run: |
          # Docker Compose V2 is already included in modern Docker installations
          # Just verify and create alias if needed
          docker compose version || (
            echo "Installing Docker Compose V2 plugin..."
            DOCKER_CONFIG=${DOCKER_CONFIG:-$HOME/.docker}
            mkdir -p $DOCKER_CONFIG/cli-plugins
            curl -SL https://github.com/docker/compose/releases/download/v2.31.0/docker-compose-linux-x86_64 -o $DOCKER_CONFIG/cli-plugins/docker-compose
            chmod +x $DOCKER_CONFIG/cli-plugins/docker-compose
          )

      - name: Verify Docker and Docker Compose
        run: |
          docker --version
          docker compose version

      - name: Run integration tests with Docker
        run: make test-integration

      - name: Create Kind cluster
        uses: helm/kind-action@v1.13.0
        with:
          version: v0.30.0
          node_image: kindest/node:v1.33.4
          cluster_name: openldap-operator-test
          wait: 120s

      - name: Verify Kind cluster
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Install LDAP server in Kind
        run: |
          kubectl create namespace ldap-test
          kubectl -n ldap-test create secret generic ldap-admin-pass --from-literal=adminpassword=admin

          kubectl -n ldap-test apply -f - <<EOF
          apiVersion: v1
          kind: Service
          metadata:
            name: openldap
          spec:
            type: ClusterIP
            ports:
            - name: ldap
              port: 389
              targetPort: 389
            selector:
              app: openldap
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: openldap
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: openldap
            template:
              metadata:
                labels:
                  app: openldap
              spec:
                containers:
                - name: openldap
                  image: osixia/openldap:1.5.0
                  ports:
                  - containerPort: 389
                  env:
                  - name: LDAP_ORGANISATION
                    value: "Example Inc"
                  - name: LDAP_DOMAIN
                    value: "example.com"
                  - name: LDAP_ADMIN_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: ldap-admin-pass
                        key: adminpassword
                  - name: LDAP_TLS
                    value: "false"
                  readinessProbe:
                    tcpSocket:
                      port: 389
                    initialDelaySeconds: 10
                    periodSeconds: 5
          EOF

      - name: Wait for LDAP server
        run: kubectl -n ldap-test wait --for=condition=available --timeout=120s deployment/openldap

      - name: Build and load operator image
        run: |
          make docker-build IMG=openldap-operator:test
          kind load docker-image openldap-operator:test --name openldap-operator-test

      - name: Install operator in Kind
        run: |
          kubectl apply -f deploy/helm/openldap-operator/crds/
          kubectl create namespace openldap-operator-system

          kubectl -n openldap-operator-system apply -f - <<EOF
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: openldap-operator-controller-manager
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: openldap-operator-controller-manager
          spec:
            replicas: 1
            selector:
              matchLabels:
                control-plane: controller-manager
            template:
              metadata:
                labels:
                  control-plane: controller-manager
              spec:
                serviceAccountName: openldap-operator-controller-manager
                containers:
                - name: manager
                  image: openldap-operator:test
                  imagePullPolicy: Never
                  command:
                  - /manager
                  env:
                  - name: ENABLE_WEBHOOKS
                    value: "false"
                  resources:
                    limits:
                      cpu: 500m
                      memory: 128Mi
                    requests:
                      cpu: 10m
                      memory: 64Mi
                  livenessProbe:
                    httpGet:
                      path: /healthz
                      port: 8081
                    initialDelaySeconds: 15
                    periodSeconds: 20
                  readinessProbe:
                    httpGet:
                      path: /readyz
                      port: 8081
                    initialDelaySeconds: 5
                    periodSeconds: 10
          EOF

      - name: Wait for operator
        run: kubectl -n openldap-operator-system wait --for=condition=available --timeout=120s deployment/openldap-operator-controller-manager

      - name: Create test resources
        run: |
          kubectl -n ldap-test apply -f - <<EOF
          apiVersion: openldap.guided-traffic.com/v1
          kind: LDAPServer
          metadata:
            name: test-ldap-server
          spec:
            host: openldap.ldap-test.svc.cluster.local
            port: 389
            baseDN: dc=example,dc=com
            bindDN: cn=admin,dc=example,dc=com
            bindPasswordSecret:
              name: ldap-admin-pass
              key: adminpassword
            tls:
              enabled: false
            healthCheckInterval: 30s
          ---
          apiVersion: openldap.guided-traffic.com/v1
          kind: LDAPGroup
          metadata:
            name: test-group
          spec:
            ldapServerRef:
              name: test-ldap-server
            groupName: testgroup
            organizationalUnit: groups
            groupType: posixGroup
            groupID: 5000
            description: "Test group"
          ---
          apiVersion: openldap.guided-traffic.com/v1
          kind: LDAPUser
          metadata:
            name: test-user
          spec:
            ldapServerRef:
              name: test-ldap-server
            username: testuser
            organizationalUnit: users
            firstName: Test
            lastName: User
            displayName: Test User
            email: testuser@example.com
            userID: 10001
            groupID: 5000
            groups:
            - testgroup
          EOF

      - name: Wait for resources to sync
        run: |
          timeout 60s bash -c 'until kubectl -n ldap-test get ldapserver test-ldap-server -o jsonpath="{.status.connectionStatus}" | grep -q "Connected"; do sleep 2; done'
          timeout 60s bash -c 'until kubectl -n ldap-test get ldapgroup test-group -o jsonpath="{.status.phase}" | grep -q "Ready"; do sleep 2; done'
          timeout 60s bash -c 'until kubectl -n ldap-test get ldapuser test-user -o jsonpath="{.status.phase}" | grep -qE "Ready|Warning"; do sleep 2; done'

      - name: Verify user in LDAP
        run: |
          kubectl -n ldap-test exec deployment/openldap -- \
            ldapsearch -x -H ldap://localhost:389 -D "cn=admin,dc=example,dc=com" -w admin \
            -b "cn=testgroup,ou=groups,dc=example,dc=com" memberUid | grep testuser

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Operator Logs ==="
          kubectl -n openldap-operator-system logs deployment/openldap-operator-controller-manager || true
          echo "=== LDAP Server Logs ==="
          kubectl -n ldap-test logs deployment/openldap || true
          echo "=== Resource Status ==="
          kubectl -n ldap-test get ldapserver,ldapgroup,ldapuser -o yaml || true

      - name: Cleanup Kind cluster
        if: always()
        run: kind delete cluster --name openldap-operator-test || true

  semantic-release:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    name: Release
    runs-on: self-hosted
    needs: [unit-tests, gosec, govulncheck, linter, integration-tests]
    permissions:
      contents: write # to be able to publish a GitHub release
      issues: write # to be able to comment on released issues
      pull-requests: write # to be able to comment on released pull requests
      id-token: write # to enable use of OIDC for npm provenance
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "lts/*"
      - name: Install dependencies
        run: npm install
      - name: Verify the integrity of provenance attestations and registry signatures for installed dependencies
        run: npm audit signatures
      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.USER_PAT }}
        run: npx semantic-release
